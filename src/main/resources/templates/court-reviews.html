<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Court Reviews & Feedback</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            background: white;
            border-radius: 12px;
            padding: 20px 30px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .back-btn {
            background: #667eea;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }

        .back-btn:hover {
            background: #5568d3;
            transform: translateY(-2px);
        }

        .court-header {
            flex: 1;
            margin-left: 20px;
        }

        .court-header h1 {
            color: #333;
            font-size: 28px;
            margin-bottom: 5px;
        }

        .court-header p {
            color: #666;
            font-size: 14px;
        }

        .content-grid {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .court-info-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .court-image {
            width: 100%;
            height: 250px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .info-item {
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #f0f0f0;
        }

        .info-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .info-label {
            font-weight: 600;
            color: #667eea;
            font-size: 14px;
            margin-bottom: 5px;
        }

        .info-value {
            color: #333;
            font-size: 16px;
        }

        .reviews-section {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .section-title {
            font-size: 24px;
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }

        .review-stats {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 25px;
            color: white;
            display: none;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 30px;
            align-items: center;
        }

        .avg-rating-box {
            text-align: center;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            backdrop-filter: blur(10px);
        }

        .avg-rating-number {
            font-size: 56px;
            font-weight: bold;
            line-height: 1;
            margin-bottom: 10px;
        }

        .avg-stars {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .total-reviews {
            font-size: 14px;
            opacity: 0.9;
        }

        .rating-bars {
            flex: 1;
        }

        .rating-bar-item {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 10px;
        }

        .rating-bar-item:last-child {
            margin-bottom: 0;
        }

        .star-label {
            font-size: 16px;
            width: 50px;
            font-weight: 600;
        }

        .bar-container {
            flex: 1;
            height: 10px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 5px;
            overflow: hidden;
        }

        .bar-fill {
            height: 100%;
            background: #FFD700;
            border-radius: 5px;
            transition: width 0.3s ease;
        }

        .bar-count {
            width: 40px;
            text-align: right;
            font-weight: 600;
        }

        .add-review-form {
            background: linear-gradient(135deg, #f8f9ff 0%, #f0f2ff 100%);
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 25px;
            border: 2px solid #667eea;
            display: none;
        }

        .form-title {
            font-size: 20px;
            color: #667eea;
            font-weight: 600;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .star-rating {
            font-size: 40px;
            cursor: pointer;
            display: inline-block;
        }

        .star {
            color: #ddd;
            transition: color 0.2s;
            display: inline-block;
            margin: 0 2px;
        }

        .star:hover,
        .star.active {
            color: #FFA500;
        }

        .review-textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            resize: vertical;
            font-family: inherit;
            font-size: 15px;
            transition: border-color 0.3s;
        }

        .review-textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .submit-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 32px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(102, 126, 234, 0.4);
        }

        .reviews-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .review-card {
            background: white;
            border: 2px solid #f0f0f0;
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s;
        }

        .review-card:hover {
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.1);
        }

        .review-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 12px;
        }

        .reviewer-info {
            flex: 1;
        }

        .reviewer-name {
            font-weight: 600;
            color: #333;
            font-size: 16px;
            margin-bottom: 5px;
        }

        .review-stars {
            color: #FFA500;
            font-size: 20px;
            margin-bottom: 5px;
        }

        .review-date {
            color: #999;
            font-size: 13px;
        }

        .review-comment {
            color: #555;
            line-height: 1.6;
            font-size: 15px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 15px;
        }

        .empty-state-title {
            font-size: 20px;
            margin-bottom: 8px;
            color: #666;
        }

        .empty-state-subtitle {
            font-size: 15px;
        }

        .message {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            z-index: 1000;
            animation: slideIn 0.3s ease;
            display: none;
        }

        .message.success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        }

        .message.error {
            background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%);
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @media (max-width: 768px) {
            .content-grid {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .header {
                flex-direction: column;
                text-align: center;
            }

            .court-header {
                margin-left: 0;
                margin-top: 15px;
            }
        }
    </style>
</head>
<body>
    <div id="message" class="message"></div>

    <div class="container">
        <div class="header">
            <button class="back-btn" onclick="goBack()">
                <span>‚Üê</span>
                <span>Back to Dashboard</span>
            </button>
            <div class="court-header">
                <h1 id="courtName">Court Name</h1>
                <p id="courtLocation">Location</p>
            </div>
        </div>

        <div class="content-grid">
            <!-- Court Information Card -->
            <div class="court-info-card">
                <img id="courtImage" class="court-image" src="" alt="Court Image">
                <div class="info-item">
                    <div class="info-label">Court Type</div>
                    <div class="info-value" id="courtType">-</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Price per Hour</div>
                    <div class="info-value" id="courtPrice">-</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Status</div>
                    <div class="info-value" id="courtStatus">-</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Description</div>
                    <div class="info-value" id="courtDescription">-</div>
                </div>
            </div>

            <!-- Reviews Section -->
            <div class="reviews-section">
                <h2 class="section-title">‚≠ê Reviews & Feedback</h2>

                <!-- Review Statistics -->
                <div id="reviewStats" class="review-stats">
                    <div class="stats-grid">
                        <div class="avg-rating-box">
                            <div class="avg-rating-number" id="avgRating">0.0</div>
                            <div class="avg-stars" id="avgStars">‚òÜ‚òÜ‚òÜ‚òÜ‚òÜ</div>
                            <div class="total-reviews" id="totalReviews">0 reviews</div>
                        </div>
                        <div class="rating-bars">
                            <div class="rating-bar-item">
                                <span class="star-label">5 ‚≠ê</span>
                                <div class="bar-container">
                                    <div class="bar-fill" id="bar5"></div>
                                </div>
                                <span class="bar-count" id="count5">0</span>
                            </div>
                            <div class="rating-bar-item">
                                <span class="star-label">4 ‚≠ê</span>
                                <div class="bar-container">
                                    <div class="bar-fill" id="bar4"></div>
                                </div>
                                <span class="bar-count" id="count4">0</span>
                            </div>
                            <div class="rating-bar-item">
                                <span class="star-label">3 ‚≠ê</span>
                                <div class="bar-container">
                                    <div class="bar-fill" id="bar3"></div>
                                </div>
                                <span class="bar-count" id="count3">0</span>
                            </div>
                            <div class="rating-bar-item">
                                <span class="star-label">2 ‚≠ê</span>
                                <div class="bar-container">
                                    <div class="bar-fill" id="bar2"></div>
                                </div>
                                <span class="bar-count" id="count2">0</span>
                            </div>
                            <div class="rating-bar-item">
                                <span class="star-label">1 ‚≠ê</span>
                                <div class="bar-container">
                                    <div class="bar-fill" id="bar1"></div>
                                </div>
                                <span class="bar-count" id="count1">0</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Booking Status Info -->
                <div id="bookingStatusInfo" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); padding: 20px; border-radius: 12px; margin-bottom: 25px; color: white; display: none;">
                    <h4 style="margin: 0 0 10px 0;">‚ÑπÔ∏è Review Permission</h4>
                    <p id="statusMessage" style="margin: 0; font-size: 15px;"></p>
                </div>

                <!-- Feedback Button (Small) -->
                <div id="feedbackButton" style="margin-bottom: 20px;">
                    <button type="button" onclick="toggleFeedbackForm()" 
                            style="background: linear-gradient(135deg, #FF6B35 0%, #FF8C42 100%);
                                   color: white;
                                   padding: 10px 20px;
                                   border: none;
                                   border-radius: 8px;
                                   cursor: pointer;
                                   font-size: 14px;
                                   font-weight: 600;
                                   box-shadow: 0 2px 8px rgba(255, 107, 53, 0.3);
                                   transition: all 0.2s ease;"
                            onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 12px rgba(255, 107, 53, 0.4)'"
                            onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(255, 107, 53, 0.3)'">
                        ‚≠ê G·ª≠i Feedback
                    </button>
                </div>

                <!-- Add Review Form (Hidden by default) -->
                <div id="addReviewForm" class="add-review-form" style="display: none;">
                    <h3 class="form-title">üìù Write Your Review</h3>
                    <div class="form-group">
                        <label class="form-label">Rating: <span id="ratingValue" style="color: #667eea; font-weight: bold;">(Not selected)</span></label>
                        <div class="star-rating" id="starRating">
                            <span class="star" data-rating="1" onclick="setRating(1)">‚òÖ</span>
                            <span class="star" data-rating="2" onclick="setRating(2)">‚òÖ</span>
                            <span class="star" data-rating="3" onclick="setRating(3)">‚òÖ</span>
                            <span class="star" data-rating="4" onclick="setRating(4)">‚òÖ</span>
                            <span class="star" data-rating="5" onclick="setRating(5)">‚òÖ</span>
                        </div>
                        <input type="hidden" id="selectedRating" value="0">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Your Review:</label>
                        <textarea id="reviewComment" class="review-textarea" rows="5" placeholder="Share your experience with this court..."></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">üì∑ Upload Image (Optional):</label>
                        <input type="file" id="reviewImage" accept="image/*" 
                               style="width: 100%; padding: 12px; border: 2px dashed #667eea; border-radius: 8px; cursor: pointer;"
                               onchange="previewImage(event)">
                        <div id="imagePreview" style="margin-top: 15px; display: none;">
                            <img id="previewImg" style="max-width: 100%; max-height: 300px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.2);">
                            <button type="button" onclick="removeImage()" 
                                    style="margin-top: 10px; background: #f44336; color: white; padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer;">
                                üóëÔ∏è Remove Image
                            </button>
                        </div>
                    </div>
                    <button type="button" 
                            onclick="submitReview()" 
                            style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
                                   color: white; 
                                   padding: 10px 24px; 
                                   border: none; 
                                   border-radius: 8px; 
                                   cursor: pointer; 
                                   font-size: 14px; 
                                   font-weight: 600;
                                   width: 100%;
                                   margin-top: 15px;
                                   box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
                                   transition: all 0.2s ease;"
                            onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 12px rgba(102, 126, 234, 0.5)'"
                            onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(102, 126, 234, 0.3)'">
                        üì§ G·ª≠i ƒê√°nh Gi√°
                    </button>
                </div>

                <!-- Reviews List -->
                <div id="reviewsList" class="reviews-list">
                    <!-- Reviews will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentCourtId = null;
        let userCompletedBookings = [];

        // Get court ID from URL
        function getCourtIdFromURL() {
            const params = new URLSearchParams(window.location.search);
            return params.get('courtId');
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            currentCourtId = getCourtIdFromURL();
            if (!currentCourtId) {
                showMessage('No court selected', 'error');
                setTimeout(() => window.location.href = '/dashboard', 2000);
                return;
            }

            loadCourtInfo();
            loadReviewStats();
            checkUserBookings();

            // Star hover effects
            const stars = document.querySelectorAll('.star');
            stars.forEach(star => {
                star.addEventListener('mouseenter', function() {
                    const hoverRating = parseInt(this.getAttribute('data-rating'));
                    highlightStars(hoverRating);
                });
            });

            document.getElementById('starRating').addEventListener('mouseleave', function() {
                const selectedRating = parseInt(document.getElementById('selectedRating').value);
                highlightStars(selectedRating);
            });
        });

        // Load court information
        function loadCourtInfo() {
            fetch('/api/courts/' + currentCourtId)
                .then(response => response.json())
                .then(result => {
                    const court = result.data || result;
                    
                    document.getElementById('courtName').textContent = court.name || 'Court Details';
                    document.getElementById('courtLocation').textContent = court.location || '';
                    document.getElementById('courtType').textContent = court.type || court.courtType || 'N/A';
                    document.getElementById('courtPrice').textContent = formatPrice(court.basePricePerHour || court.pricePerHour || 0);
                    document.getElementById('courtStatus').textContent = court.isAvailable ? '‚úÖ Available' : '‚ùå Not Available';
                    document.getElementById('courtDescription').textContent = court.description || 'No description available';
                    
                    if (court.imageUrl) {
                        document.getElementById('courtImage').src = court.imageUrl;
                    } else {
                        document.getElementById('courtImage').style.display = 'none';
                    }
                })
                .catch(error => {
                    console.error('Error loading court info:', error);
                    showMessage('Error loading court information', 'error');
                });
        }

        // Load review statistics
        function loadReviewStats() {
            console.log('Loading review stats for court:', currentCourtId);
            fetch('/api/reviews/court/' + currentCourtId + '/stats')
                .then(response => response.json())
                .then(result => {
                    console.log('Review stats response:', result);
                    const stats = result.data || result;
                    const reviews = stats.reviews || [];
                    const avgRating = stats.averageRating || 0;
                    const totalReviews = stats.totalReviews || 0;
                    const ratingCounts = stats.ratingCounts || {};

                    console.log('Total reviews:', totalReviews, 'Reviews:', reviews);

                    // Show review stats if there are reviews
                    if (totalReviews > 0) {
                        document.getElementById('reviewStats').style.display = 'block';
                        document.getElementById('avgRating').textContent = avgRating.toFixed(1);
                        document.getElementById('totalReviews').textContent = totalReviews + ' review' + (totalReviews > 1 ? 's' : '');

                        // Update star display
                        const fullStars = Math.floor(avgRating);
                        const hasHalfStar = (avgRating - fullStars) >= 0.5;
                        let starsHtml = '';
                        for (let i = 0; i < fullStars; i++) starsHtml += '‚òÖ';
                        if (hasHalfStar) starsHtml += '‚≠ê';
                        for (let i = fullStars + (hasHalfStar ? 1 : 0); i < 5; i++) starsHtml += '‚òÜ';
                        document.getElementById('avgStars').innerHTML = starsHtml;

                        // Update rating bars
                        for (let i = 1; i <= 5; i++) {
                            const count = ratingCounts[i] || 0;
                            const percentage = totalReviews > 0 ? (count / totalReviews * 100) : 0;
                            document.getElementById('bar' + i).style.width = percentage + '%';
                            document.getElementById('count' + i).textContent = count;
                        }
                    }

                    // Display reviews
                    displayReviews(reviews);
                })
                .catch(error => {
                    console.error('‚ùå ERROR loading review stats:', error);
                    showMessage('Error loading reviews: ' + error.message, 'error');
                    // Still show empty state
                    displayReviews([]);
                });
        }

        // Display reviews
        function displayReviews(reviews) {
            const reviewsList = document.getElementById('reviewsList');

            console.log('displayReviews called with:', reviews);
            console.log('Number of reviews:', reviews ? reviews.length : 0);

            if (!reviews || reviews.length === 0) {
                reviewsList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìù</div>
                        <div class="empty-state-title">No reviews yet</div>
                        <div class="empty-state-subtitle">Be the first to review this court!</div>
                    </div>
                `;
                return;
            }

            let reviewsHtml = '';
            reviews.forEach(review => {
                const stars = '‚òÖ'.repeat(review.rating) + '‚òÜ'.repeat(5 - review.rating);
                const createdDate = new Date(review.createdAt);
                const dateStr = createdDate.toLocaleDateString('en-US', { 
                    year: 'numeric', 
                    month: 'short', 
                    day: 'numeric' 
                });

                reviewsHtml += `
                    <div class="review-card">
                        <div class="review-header">
                            <div class="reviewer-info">
                                <div class="reviewer-name">${review.userName || 'Anonymous'}</div>
                                <div class="review-stars">${stars}</div>
                            </div>
                            <div class="review-date">${dateStr}</div>
                        </div>
                        ${review.comment ? `<div class="review-comment">${review.comment}</div>` : ''}
                        ${review.imageUrl ? `<div style="margin-top: 15px;"><img src="${review.imageUrl}" style="max-width: 100%; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.15);" alt="Review image"></div>` : ''}
                    </div>
                `;
            });

            reviewsList.innerHTML = reviewsHtml;
        }

        // Check user bookings
        function checkUserBookings() {
            fetch('/api/bookings/my-bookings')
                .then(response => response.json())
                .then(result => {
                    console.log('All user bookings:', result);
                    const allBookings = result.data || result || [];
                    const bookingsForThisCourt = allBookings.filter(b => b.courtId == currentCourtId);
                    // Accept both CONFIRMED and COMPLETED bookings for reviews (demo purpose)
                    userCompletedBookings = bookingsForThisCourt.filter(b => 
                        b.status === 'COMPLETED' || b.status === 'CONFIRMED'
                    );
                    
                    console.log('Valid bookings for review:', userCompletedBookings);
                    
                    const statusInfo = document.getElementById('bookingStatusInfo');
                    const statusMessage = document.getElementById('statusMessage');
                    
                    if (userCompletedBookings.length > 0) {
                        statusInfo.style.background = 'linear-gradient(135deg, #11998e 0%, #38ef7d 100%)';
                        statusInfo.style.display = 'block';
                        statusMessage.textContent = '‚úÖ B·∫°n c√≥ th·ªÉ vi·∫øt ƒë√°nh gi√°! B·∫°n c√≥ ' + userCompletedBookings.length + ' booking cho s√¢n n√†y (Status: ' + userCompletedBookings[0].status + ').';
                    } else if (bookingsForThisCourt.length > 0) {
                        statusInfo.style.background = 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)';
                        statusInfo.style.display = 'block';
                        statusMessage.textContent = 'üïí B·∫°n c√≥ ' + bookingsForThisCourt.length + ' booking cho s√¢n n√†y (Status: ' + bookingsForThisCourt[0].status + '). Ch·ªù x√°c nh·∫≠n ƒë·ªÉ vi·∫øt ƒë√°nh gi√°!';
                    } else {
                        statusInfo.style.background = 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)';
                        statusInfo.style.display = 'block';
                        statusMessage.textContent = 'üèüÔ∏è ƒê·∫∑t s√¢n n√†y ƒë·ªÉ c√≥ th·ªÉ vi·∫øt ƒë√°nh gi√°!';
                    }
                })
                .catch(error => {
                    console.error('Error checking user bookings:', error);
                });
        }

        // Toggle feedback form
        function toggleFeedbackForm() {
            const form = document.getElementById('addReviewForm');
            const button = document.getElementById('feedbackButton');
            
            if (form.style.display === 'none' || form.style.display === '') {
                form.style.display = 'block';
                button.style.display = 'none';
                form.scrollIntoView({ behavior: 'smooth', block: 'start' });
            } else {
                form.style.display = 'none';
                button.style.display = 'block';
            }
        }

        // Image preview functions
        function previewImage(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('previewImg').src = e.target.result;
                    document.getElementById('imagePreview').style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        }

        function removeImage() {
            document.getElementById('reviewImage').value = '';
            document.getElementById('imagePreview').style.display = 'none';
            document.getElementById('previewImg').src = '';
        }

        // Star rating functions
        function setRating(rating) {
            document.getElementById('selectedRating').value = rating;
            document.getElementById('ratingValue').textContent = rating + ' ‚òÖ'.repeat(rating);
            document.getElementById('ratingValue').style.color = '#FFA500';
            highlightStars(rating);
        }

        function highlightStars(rating) {
            const stars = document.querySelectorAll('.star');
            stars.forEach(star => {
                const starRating = parseInt(star.getAttribute('data-rating'));
                if (starRating <= rating) {
                    star.classList.add('active');
                } else {
                    star.classList.remove('active');
                }
            });
        }

        // Submit review
        function submitReview() {
            const rating = parseInt(document.getElementById('selectedRating').value);
            const comment = document.getElementById('reviewComment').value.trim();
            const imageFile = document.getElementById('reviewImage').files[0];

            console.log('Submitting review:', { rating, comment, hasImage: !!imageFile, userCompletedBookings });

            if (rating === 0) {
                showMessage('Please select a rating (click on the stars)', 'error');
                return;
            }

            if (userCompletedBookings.length === 0) {
                showMessage('‚ö†Ô∏è B·∫°n c·∫ßn c√≥ booking (CONFIRMED ho·∫∑c COMPLETED) ƒë·ªÉ ƒë√°nh gi√° s√¢n n√†y!', 'error');
                return;
            }

            const bookingId = userCompletedBookings[0].id;
            
            // If there's an image, convert to base64 or upload to image hosting
            // For now, we'll use a placeholder or upload to imgur/cloudinary
            let imageUrl = null;
            
            if (imageFile) {
                // Convert to base64 for demo (in production, upload to cloud storage)
                const reader = new FileReader();
                reader.onload = function(e) {
                    imageUrl = e.target.result;
                    sendReview(bookingId, rating, comment, imageUrl);
                };
                reader.readAsDataURL(imageFile);
            } else {
                sendReview(bookingId, rating, comment, null);
            }
        }
        
        function sendReview(bookingId, rating, comment, imageUrl) {
            const reviewData = { rating, comment, imageUrl };

            console.log('Sending review to API:', '/api/reviews/booking/' + bookingId, reviewData);

            fetch('/api/reviews/booking/' + bookingId, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(reviewData)
            })
            .then(response => {
                console.log('Response status:', response.status);
                return response.json();
            })
            .then(result => {
                console.log('Review submission result:', result);
                if (result.success) {
                    showMessage('‚úÖ ƒê√°nh gi√° ƒë√£ g·ª≠i th√†nh c√¥ng! ƒêang t·∫£i l·∫°i trang...', 'success');
                    // Reload page after 1.5 seconds to show new review
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                } else {
                    showMessage('‚ùå ' + (result.message || 'Failed to submit review'), 'error');
                }
            })
            .catch(error => {
                console.error('Error submitting review:', error);
                showMessage('‚ùå Error submitting review. Check console for details.', 'error');
            });
        }

        // Utility functions
        function formatPrice(price) {
            return new Intl.NumberFormat('vi-VN', { 
                style: 'currency', 
                currency: 'VND' 
            }).format(price);
        }

        function showMessage(text, type) {
            const messageEl = document.getElementById('message');
            messageEl.textContent = text;
            messageEl.className = 'message ' + type;
            messageEl.style.display = 'block';
            
            setTimeout(() => {
                messageEl.style.display = 'none';
            }, 3000);
        }

        function goBack() {
            window.location.href = '/dashboard';
        }
    </script>
</body>
</html>
